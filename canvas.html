<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Rifrazione - Canvas</title>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: 'Poppins', sans-serif;
    background: #fafafa;
    color: #333;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    padding: 1.5em;
    border-bottom: 2px solid #ddd;
    text-align: center;
    background: #f0f0f0;
  }

  header h1 {
    margin: 0;
    font-size: 2em;
    font-weight: bold;
    color: #444;
  }

  header h2 {
    margin: 0.3em 0 0;
    font-size: 1.2em;
    font-weight: normal;
    color: #666;
  }

  nav {
    margin-top: 1em;
  }

  nav a {
    text-decoration: none;
    color: #0077cc;
    font-size: 0.9em;
    font-weight: bold;
    transition: color 0.3s;
  }

  nav a:hover {
    color: #005fa3;
  }

  .settings {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 1em;
    border-bottom: 2px solid #ddd;
    gap: 1.5em;
    background: #fff;
  }

  .settings label {
    margin-right: 0.5em;
    font-size: 0.95em;
    color: #333;
  }

  .color-controls {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    padding: 1em;
    border-bottom: 2px solid #ddd;
    gap: 2em;
    background: #fff;
  }

  .colore-disegnare, .colore-confronto {
    display: flex;
    flex-direction: column;
    gap: 0.5em;
  }

  .colore-disegnare label, .colore-confronto label {
    font-size: 0.95em;
    font-weight: bold;
    color: #444;
  }

  select, input[type="color"] {
    font-size: 1em;
    padding: 0.3em;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    transition: border 0.3s;
  }

  select:focus, input[type="color"]:focus {
    border-color: #0077cc;
    outline: none;
  }

  .average-distance {
    display: flex;
    flex-direction: row;
    gap: 1em;
    align-items: center;
  }

  .average-distance div {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    font-size: 0.95em;
  }

  #averageColorBox {
    width: 60px;
    height: 30px;
    border: 2px solid #aaa;
    margin-top: 0.3em;
  }

  #similarity {
    border: 2px solid #aaa;
    padding: 0.3em 0.5em;
    text-align: center;
    background: #f9f9f9;
    margin-top: 0.3em;
    font-size: 1em;
    min-width: 60px;
  }

  #resetButton {
    margin: 1em auto;
    display: block;
    background: #0077cc;
    border: none;
    color: #fff;
    padding: 0.8em 1.5em;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: background 0.3s, transform 0.2s;
  }

  #resetButton:hover {
    background: #005fa3;
  }

  #resetButton:active {
    transform: scale(0.98);
  }

  canvas {
    flex: 1;
    display: block;
    width: 100%;
    border: 2px dashed #aaa;
    box-sizing: border-box;
    margin-top: 1em;
  }

  @media (max-width: 600px) {
    .settings, .color-controls {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>
<header>
  <h1>Rifrazione</h1>
  <h2>Modalità canvas</h2>
  <nav>
    <a href="camera.html">Modalità foto</a>
  </nav>
</header>
<div class="settings">
  <div>
    <label for="averageMethod">Metodo Calcolo Media:</label>
    <select id="averageMethod">
      <option value="rgb">RGB</option>
      <option value="hex">Esadecimali</option>
      <option value="lum">Pesata Luminosità</option>
      <option value="hsv">HSV</option>
    </select>
  </div>
  <div>
    <label for="distanceMethod">Metodo Calcolo Distanza:</label>
    <select id="distanceMethod">
      <option value="euclidean">Euclidea RGB</option>
      <option value="lab">Delta E (Lab)</option>
      <option value="avgchannels">Media Canali</option>
      <option value="hue">Differenza Hue (HSV)</option>
    </select>
  </div>
</div>
<div class="color-controls">
  <div class="colore-disegnare">
    <label>Colore per Disegnare:</label>
    <input type="color" id="drawColor" value="#000000">
  </div>
  <div class="colore-confronto">
    <label>Colore di Confronto:</label>
    <input type="color" id="confrontoColor" value="#ff0000">
  </div>
  <div>
    <label>Colore Medio:</label>
    <div id="averageColorBox" style="width: 50px; height: 20px; border: 1px solid #000;"></div>
  </div>
</div>
<button id="resetButton">Reset</button>
<div class="results" id="results">
  <p><strong>Colore per Disegnare:</strong>
  <p><strong>Colore di Confronto:</strong>
  <p><strong>Colore Medio:</strong>
  <p><strong>Distanza:</strong>
</div>
<canvas id="canvas"></canvas>
<script>
    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth - 20;
    canvas.height = window.innerHeight - document.querySelector('header').offsetHeight - 200;

    var painting = false;
    var drawColor = document.getElementById('drawColor').value;
    var confrontoColor = document.getElementById('confrontoColor').value;

    document.getElementById('drawColor').addEventListener('input', (e) => {
        drawColor = e.target.value;
        updateResults();
    });

    document.getElementById('confrontoColor').addEventListener('input', (e) => {
        confrontoColor = e.target.value;
        updateResults();
    });

    document.getElementById('resetButton').addEventListener('click', resetCanvas);

    function startDraw(e) {
        painting = true;
        ctx.beginPath();
        draw(e);
    }

    function endDraw() {
        painting = false;
        ctx.beginPath();
        updateResults();
    }

    function draw(e) {
        if (!painting) return;
        ctx.lineWidth = 15;
        ctx.lineCap = 'round';
        ctx.strokeStyle = drawColor;

        var rect = canvas.getBoundingClientRect();
        var x = e.clientX - rect.left;
        var y = e.clientY - rect.top;

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mousemove', draw);

    function resetCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      updateResults();
    }

    function hexToRgb(hex) {
        const bigint = parseInt(hex.slice(1), 16);
        return {
            r: (bigint >> 16) & 255,
            g: (bigint >> 8) & 255,
            b: bigint & 255
        };
    }

    function rgbToHex(r, g, b) {
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;
    }

    function calculateColorDistancePercentage(distance) {
        const maxDistance = Math.sqrt(3 * Math.pow(255, 2));
        return ((distance / maxDistance) * 100).toFixed(2);
    }

    function calculateAverageColor() {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        let r = 0, g = 0, b = 0, count = 0;

        for (let i = 0; i < data.length; i += 4) {
            if (data[i + 3] !== 0) {
                r += data[i];
                g += data[i + 1];
                b += data[i + 2];
                count++;
            }
        }

        if (count === 0) return null;
        return { r: Math.round(r / count), g: Math.round(g / count), b: Math.round(b / count) };
    }

    function calculateColorDistance(c1, c2) {
        return Math.sqrt(
            Math.pow(c1.r - c2.r, 2) +
            Math.pow(c1.g - c2.g, 2) +
            Math.pow(c1.b - c2.b, 2)
        );
    }

    function updateResults() {
        const avgColor = calculateAverageColor();

        if (!avgColor) {
            document.getElementById('results').innerHTML = `
              <p><strong>Colore per Disegnare:</strong>
              <p><strong>Colore di Confronto:</strong>
              <p><strong>Colore Medio:</strong>
              <p><strong>Distanza:</strong>`
            return;
        }

        const confrontoRgb = hexToRgb(confrontoColor);
        const avgHex = rgbToHex(avgColor.r, avgColor.g, avgColor.b);
        const dist = calculateColorDistance(avgColor, confrontoRgb);
        const distPercentage = calculateColorDistancePercentage(dist);

        document.getElementById('averageColorBox').style.backgroundColor = avgHex;
        document.getElementById('results').innerHTML = `
            <p><strong>Colore per Disegnare:</strong> ${drawColor} (${hexToRgb(drawColor).r}, ${hexToRgb(drawColor).g}, ${hexToRgb(drawColor).b})</p>
            <p><strong>Colore di Confronto:</strong> ${confrontoColor} (${confrontoRgb.r}, ${confrontoRgb.g}, ${confrontoRgb.b})</p>
            <p><strong>Colore Medio:</strong> ${avgHex} (${avgColor.r}, ${avgColor.g}, ${avgColor.b})</p>
            <p><strong>Distanza:</strong> ${dist.toFixed(2)} (${distPercentage}%)</p>
        `;
    }
</script>
</body>
</html>
